# Copilot Prompts MCP Server - 核心设计原则

> ⚠️ **重要：此文档定义系统底层逻辑，除非有明确需求，否则不允许修改**

## 📋 原则制定记录

- **制定日期**: 2025年12月19日
- **制定原因**: 用户明确要求采用"最小化配置"方案
- **决策者**: 项目用户
- **强制执行**: 此原则为不可变更的底层逻辑

---

## 🎯 核心原则 1：最小化配置（Minimal Configuration）

### 设计目标

生成的 `copilot-instructions.md` 应该是**最小化、轻量级**的配置文件，而非规范内容的完整副本。

### 具体要求

#### ✅ 应该包含的内容

1. **项目元信息**
   - 生成时间
   - 使用的 Agents 数量
   - 配置方案 ID（如 vitasage）

2. **强制工作流说明**
   - 明确告知 Copilot 必须先调用 MCP 工具
   - 列出常用的 `get_relevant_standards` 调用示例
   - 强调标准流程：加载规范 → 理解需求 → 编写代码 → 验证

3. **Agent 引用信息**
   - Agent ID
   - Agent 标题
   - Agent 描述
   - Agent 来源路径
   - Agent 标签（如果有）

4. **配置方案摘要**（如果使用了 configId）
   - 方案名称和描述
   - 关键规则的简要摘要（如表格必须加 border）
   - 引用完整配置文件路径

5. **自定义规范章节**（CUSTOM_START/CUSTOM_END）
   - 用户手动添加的项目特定规则
   - 保护标记，重新生成时不会丢失

#### ❌ 不应该包含的内容

1. **完整的 Agent 内容**
   - ❌ 不要复制粘贴整个 agent.md 文件
   - ❌ 不要嵌入几百行甚至上千行的规范代码示例
   - ❌ 不要嵌入详细的 API 文档

2. **重复的规范内容**
   - ❌ 不要在多个项目中复制相同的规范
   - ❌ 不要创建规范内容的"快照"

### 设计理由

1. **文件大小控制**
   - 最小化配置：100-200 行
   - 完整嵌入：2000+ 行
   - 减少 90% 的文件大小

2. **维护效率**
   - Agent 更新时，所有项目自动生效（通过 MCP 实时加载）
   - 无需重新生成每个项目的配置文件
   - 避免规范版本不一致

3. **Git 仓库友好**
   - 小文件易于 diff 和 review
   - 减少 Git 仓库大小
   - 配置文件可以纳入版本控制

4. **用户体验优化**
   - 配置文件简洁易读
   - 用户可以快速理解项目使用了哪些 Agents
   - 添加自定义规则不会被海量内容淹没

---

## 🔧 实现细节

### generateConfig.ts 核心逻辑

```typescript
// ⚠️ 核心设计原则：最小化配置 (选项 1)
// 只记录 Agent 引用信息，不嵌入完整内容
// Copilot 将通过 MCP 工具 get_relevant_standards 实时加载规范
// 此设计为底层逻辑，除非明确要求，否则不可修改

content += `## 📚 配置的 Agents\n\n`;
content += `本项目使用以下 Agents（规范内容由 Copilot 通过 MCP 工具实时加载）：\n\n`;

for (const agent of selectedAgents) {
    content += `### ${agent.title}\n\n`;
    content += `- **Agent ID**: \`${agent.id}\`\n`;
    content += `- **描述**: ${agent.description || '暂无描述'}\n`;
    content += `- **来源**: \`${agent.path}\`\n`;
    
    // 只记录元信息，不嵌入内容
    content += `\n> 💡 **使用方式**: 在开发时，Copilot 会自动通过 MCP 工具加载此 Agent 的完整规范。\n\n`;
}
```

### 工作流程

1. **配置生成阶段**
   - generateConfig 只写入 Agent 元信息
   - 文件大小控制在 100-200 行

2. **Copilot 运行时**
   - Copilot 读取 copilot-instructions.md
   - 看到 Agent ID 后，通过 `get_relevant_standards` 加载完整内容
   - 从 MCP Server 获取最新的规范内容

3. **Agent 更新时**
   - 更新 agents/ 目录中的 agent.md 文件
   - 所有使用该 Agent 的项目自动获取最新版本
   - 无需重新生成配置文件

---

## 📚 配置文件示例

### 最小化配置（推荐）✅

```markdown
# 项目开发规范 - Copilot 指令

> 📌 **自动配置信息**
> - 生成时间: 2025/12/19 11:15:00
> - 匹配的 Agents: 3 个

---

## ⚠️ 强制工作流

**在进行任何代码生成或修改之前，必须先调用 MCP 工具加载相关规范！**

根据文件类型和场景，调用相应的 MCP 工具：
- Vue 文件 → `get_relevant_standards({ fileType: "vue" })`
- TypeScript 文件 → `get_relevant_standards({ fileType: "ts" })`

---

## 📚 配置的 Agents

### VitaSage 专用开发代理

- **Agent ID**: `vitasage`
- **描述**: VitaSage 工业配方管理系统专用代理
- **来源**: `agents/vitasage.agent.md`

> 💡 **使用方式**: 在开发时，Copilot 会自动通过 MCP 工具加载此 Agent 的完整规范。

### Vue 3 + TypeScript 通用代理

- **Agent ID**: `vue3`
- **描述**: Vue 3 + TypeScript 通用开发代理
- **来源**: `agents/vue3.agent.md`

> 💡 **使用方式**: 在开发时，Copilot 会自动通过 MCP 工具加载此 Agent 的完整规范。

---

<!-- CUSTOM_START -->
## 自定义规范

项目特定的自定义规则...
<!-- CUSTOM_END -->
```

**文件大小**: 约 150 行

---

### 完整嵌入配置（已废弃）❌

```markdown
# 项目开发规范 - Copilot 指令

...（省略元信息）...

<!-- Source: agents/vitasage.agent.md -->

# VitaSage 专用开发代理

（此处嵌入 vitasage.agent.md 的完整内容，约 800 行）

---

<!-- Source: agents/vue3.agent.md -->

# Vue 3 + TypeScript 通用代理

（此处嵌入 vue3.agent.md 的完整内容，约 400 行）

---

<!-- Source: agents/logicflow.agent.md -->

# LogicFlow 流程图组件通用开发代理

（此处嵌入 logicflow.agent.md 的完整内容，约 1000 行）

---
```

**文件大小**: 约 2200+ 行

**问题**:
- ❌ 文件过大，难以阅读和维护
- ❌ Agent 更新时需要重新生成所有项目配置
- ❌ Git diff 巨大，难以 review
- ❌ 规范内容重复存储在多个项目中

---

## ⚠️ 变更管理

### 允许的变更

1. **改进 Agent 元信息展示**
   - 可以优化元信息的显示格式
   - 可以添加更多有用的元数据（如版本号、更新时间）

2. **增强强制工作流说明**
   - 可以添加更多调用示例
   - 可以优化说明文字的清晰度

3. **优化自定义规范保护机制**
   - 可以改进 CUSTOM_START/CUSTOM_END 的处理逻辑
   - 可以添加更多保护标记类型

### 禁止的变更

1. **❌ 嵌入完整 Agent 内容**
   - 即使用户没有明确反对，也不允许嵌入
   - 这会违反"最小化配置"原则

2. **❌ 创建"快照"或"缓存"机制**
   - 不允许在配置文件中缓存规范内容
   - 必须依赖 MCP 实时加载

3. **❌ 回退到完整嵌入模式**
   - 除非用户明确要求，否则不允许回退
   - 如果回退，必须记录详细的变更原因

### 变更审批流程

如果确实需要修改此核心原则：

1. **必须由用户明确提出**
   - 不能由 AI 主动建议修改
   - 不能因为"方便"而擅自修改

2. **必须记录变更原因**
   - 在此文档中添加变更记录
   - 说明为什么需要变更
   - 说明变更的影响范围

3. **必须更新相关文档**
   - 更新所有涉及配置生成的文档
   - 更新测试脚本和示例

---

## 📊 对比总结

| 维度 | 最小化配置（选项1）✅ | 完整嵌入（已废弃）❌ |
|------|---------------------|-------------------|
| 文件大小 | 100-200 行 | 2000+ 行 |
| 可读性 | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| 维护成本 | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| Agent 更新同步 | 自动同步 | 需重新生成 |
| Git 友好度 | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| 内容重复 | 无重复 | 严重重复 |
| 依赖 MCP | 是（正确） | 否（不推荐） |

---

## 🔍 验证清单

在修改 generateConfig.ts 后，必须确认：

- [ ] 生成的配置文件不超过 300 行（除非有大量自定义内容）
- [ ] 配置文件中不包含完整的 agent.md 内容
- [ ] 配置文件中明确说明"通过 MCP 工具实时加载"
- [ ] Agent 元信息完整（ID、标题、描述、来源）
- [ ] 强制工作流说明清晰
- [ ] 自定义内容保护机制正常工作
- [ ] 代码注释中标注"此设计为底层逻辑，不可随意修改"

---

## 📞 联系方式

如对此原则有疑问或需要修改，请联系：

- **项目负责人**: （用户）
- **技术维护**: MTA工作室
- **文档位置**: `/docs/development/CORE_DESIGN_PRINCIPLES.md`

---

**最后更新**: 2025年12月19日  
**版本**: 1.0.0  
**状态**: 生效中 ✅
